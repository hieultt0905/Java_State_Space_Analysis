const fs = require('fs')
const bodyParser = require('body-parser')
const app = require('express')()
const server = require('http').Server(app)
const io = require('socket.io')(server);
const dotParser = require('./dot-parser.js')
const Viz = require('viz.js');
const { Module, render } = require('viz.js/full.render.js');
const viz = new Viz({ Module, render });

String.prototype.format = function() {
  a = this
  for (k in arguments) {
    a = a.replace("{" + k + "}", arguments[k])
  }
  return a
}

server.listen(2000)
const port = 3000
ss = JSON.parse(`
  {"node":{"110":"110\\n4, 6, 3, 1, 1, ","111":"111\\n4, 6, 3, 1, 1, ","112":"112\\n3, 5, 5, 1, 0, ","113":"113\\n4, 6, 3, 1, 1, ","114":"114\\n4, 6, 3, 1, 1, ","115":"115\\n4, 6, 3, 1, 1, ","116":"116\\n3, 5, 5, 1, 0, ","117":"117\\n4, 6, 3, 1, 1, ","118":"118\\n4, 6, 3, 1, 1, ","119":"119\\n4, 6, 3, 1, 1, ","10":"10\\n6, 8, 2, 1, 0, ","11":"11\\n6, 8, 2, 1, 0, ","12":"12\\n6, 8, 2, 1, 0, ","13":"13\\n6, 8, 2, 1, 0, ","14":"14\\n6, 8, 2, 1, 0, ","15":"15\\n6, 8, 2, 1, 0, ","16":"16\\n7, 9, 0, 1, 1, ","17":"17\\n6, 8, 2, 1, 0, ","18":"18\\n6, 8, 2, 1, 0, ","19":"19\\n6, 8, 2, 1, 0, ","120":"120\\n4, 6, 3, 1, 1, ","0":"0\\n8, 10, 0, 1, 0, ","121":"121\\n4, 6, 3, 1, 1, ","1":"1\\n7, 9, 1, 1, 0, ","122":"122\\n5, 7, 1, 1, 2, ","2":"2\\n7, 9, 1, 1, 0, ","123":"123\\n4, 6, 3, 1, 1, ","3":"3\\n7, 9, 1, 1, 0, ","124":"124\\n4, 6, 3, 1, 1, ","4":"4\\n7, 9, 1, 1, 0, ","125":"125\\n5, 7, 1, 1, 2, ","5":"5\\n7, 9, 1, 1, 0, ","126":"126\\n3, 5, 5, 1, 0, ","6":"6\\n7, 9, 1, 1, 0, ","127":"127\\n4, 6, 3, 1, 1, ","7":"7\\n6, 8, 2, 1, 0, ","128":"128\\n4, 6, 3, 1, 1, ","8":"8\\n6, 8, 2, 1, 0, ","129":"129\\n4, 6, 3, 1, 1, ","9":"9\\n6, 8, 2, 1, 0, ","20":"20\\n6, 8, 2, 1, 0, ","21":"21\\n6, 8, 2, 1, 0, ","22":"22\\n7, 9, 0, 1, 1, ","23":"23\\n6, 8, 2, 1, 0, ","24":"24\\n7, 9, 0, 1, 1, ","25":"25\\n5, 7, 3, 1, 0, ","26":"26\\n5, 7, 3, 1, 0, ","27":"27\\n5, 7, 3, 1, 0, ","28":"28\\n5, 7, 3, 1, 0, ","29":"29\\n6, 8, 1, 1, 1, ","130":"130\\n4, 6, 3, 1, 1, ","131":"131\\n4, 6, 3, 1, 1, ","132":"132\\n4, 6, 3, 1, 1, ","133":"133\\n5, 7, 1, 1, 2, ","134":"134\\n3, 5, 5, 1, 0, ","135":"135\\n4, 6, 3, 1, 1, ","136":"136\\n4, 6, 3, 1, 1, ","137":"137\\n4, 6, 3, 1, 1, ","138":"138\\n4, 6, 3, 1, 1, ","139":"139\\n4, 6, 3, 1, 1, ","30":"30\\n5, 7, 3, 1, 0, ","31":"31\\n5, 7, 3, 1, 0, ","32":"32\\n5, 7, 3, 1, 0, ","33":"33\\n5, 7, 3, 1, 0, ","34":"34\\n5, 7, 3, 1, 0, ","35":"35\\n6, 8, 1, 1, 1, ","36":"36\\n5, 7, 3, 1, 0, ","37":"37\\n6, 8, 1, 1, 1, ","38":"38\\n5, 7, 3, 1, 0, ","39":"39\\n5, 7, 3, 1, 0, ","140":"140\\n5, 7, 1, 1, 2, ","141":"141\\n4, 6, 3, 1, 1, ","142":"142\\n4, 6, 3, 1, 1, ","143":"143\\n5, 7, 1, 1, 2, ","144":"144\\n4, 6, 3, 1, 1, ","145":"145\\n4, 6, 3, 1, 1, ","146":"146\\n4, 6, 3, 1, 1, ","147":"147\\n5, 7, 1, 1, 2, ","148":"148\\n5, 7, 1, 1, 2, ","149":"149\\n5, 7, 1, 1, 2, ","40":"40\\n5, 7, 3, 1, 0, ","41":"41\\n6, 8, 1, 1, 1, ","42":"42\\n5, 7, 3, 1, 0, ","43":"43\\n5, 7, 3, 1, 0, ","44":"44\\n6, 8, 1, 1, 1, ","45":"45\\n6, 8, 1, 1, 1, ","46":"46\\n5, 7, 3, 1, 0, ","47":"47\\n6, 8, 1, 1, 1, ","48":"48\\n6, 8, 1, 1, 1, ","49":"49\\n6, 8, 1, 1, 1, ","150":"150\\n5, 7, 1, 1, 2, ","151":"151\\n5, 7, 1, 1, 2, ","152":"152\\n4, 6, 3, 1, 1, ","153":"153\\n4, 6, 3, 1, 1, ","154":"154\\n5, 7, 1, 1, 2, ","155":"155\\n5, 7, 1, 1, 2, ","156":"156\\n2, 4, 6, 1, 0, ","157":"157\\n3, 5, 4, 1, 1, ","158":"158\\n3, 5, 4, 1, 1, ","159":"159\\n3, 5, 4, 1, 1, ","50":"50\\n5, 7, 3, 1, 0, ","51":"51\\n5, 7, 3, 1, 0, ","52":"52\\n6, 8, 1, 1, 1, ","53":"53\\n5, 7, 3, 1, 0, ","54":"54\\n6, 8, 1, 1, 1, ","55":"55\\n5, 7, 3, 1, 0, ","56":"56\\n6, 8, 1, 1, 1, ","57":"57\\n6, 8, 1, 1, 1, ","58":"58\\n6, 8, 1, 1, 1, ","59":"59\\n6, 8, 1, 1, 1, ","160":"160\\n3, 5, 4, 1, 1, ","161":"161\\n3, 5, 4, 1, 1, ","162":"162\\n4, 6, 2, 1, 2, ","163":"163\\n3, 5, 4, 1, 1, ","164":"164\\n3, 5, 4, 1, 1, ","165":"165\\n4, 6, 2, 1, 2, ","166":"166\\n3, 5, 4, 1, 1, ","167":"167\\n3, 5, 4, 1, 1, ","168":"168\\n3, 5, 4, 1, 1, ","169":"169\\n4, 6, 2, 1, 2, ","60":"60\\n4, 6, 4, 1, 0, ","61":"61\\n4, 6, 4, 1, 0, ","62":"62\\n4, 6, 4, 1, 0, ","63":"63\\n5, 7, 2, 1, 1, ","64":"64\\n4, 6, 4, 1, 0, ","65":"65\\n4, 6, 4, 1, 0, ","66":"66\\n5, 7, 2, 1, 1, ","67":"67\\n5, 7, 2, 1, 1, ","68":"68\\n4, 6, 4, 1, 0, ","69":"69\\n5, 7, 2, 1, 1, ","170":"170\\n4, 6, 2, 1, 2, ","171":"171\\n4, 6, 2, 1, 2, ","172":"172\\n4, 6, 2, 1, 2, ","173":"173\\n4, 6, 2, 1, 2, ","174":"174\\n3, 5, 4, 1, 1, ","175":"175\\n3, 5, 4, 1, 1, ","176":"176\\n4, 6, 2, 1, 2, ","177":"177\\n4, 6, 2, 1, 2, ","178":"178\\n3, 5, 4, 1, 1, ","179":"179\\n3, 5, 4, 1, 1, ","70":"70\\n5, 7, 2, 1, 1, ","71":"71\\n5, 7, 2, 1, 1, ","72":"72\\n4, 6, 4, 1, 0, ","73":"73\\n4, 6, 4, 1, 0, ","74":"74\\n5, 7, 2, 1, 1, ","75":"75\\n4, 6, 4, 1, 0, ","76":"76\\n5, 7, 2, 1, 1, ","77":"77\\n4, 6, 4, 1, 0, ","78":"78\\n5, 7, 2, 1, 1, ","79":"79\\n5, 7, 2, 1, 1, ","180":"180\\n3, 5, 4, 1, 1, ","181":"181\\n4, 6, 2, 1, 2, ","182":"182\\n4, 6, 2, 1, 2, ","183":"183\\n4, 6, 2, 1, 2, ","184":"184\\n4, 6, 2, 1, 2, ","185":"185\\n4, 6, 2, 1, 2, ","186":"186\\n4, 6, 2, 1, 2, ","187":"187\\n4, 6, 2, 1, 2, ","188":"188\\n4, 6, 2, 1, 2, ","189":"189\\n5, 7, 0, 1, 3, ","80":"80\\n5, 7, 2, 1, 1, ","81":"81\\n5, 7, 2, 1, 1, ","82":"82\\n4, 6, 4, 1, 0, ","83":"83\\n4, 6, 4, 1, 0, ","84":"84\\n5, 7, 2, 1, 1, ","85":"85\\n5, 7, 2, 1, 1, ","86":"86\\n4, 6, 4, 1, 0, ","87":"87\\n5, 7, 2, 1, 1, ","88":"88\\n5, 7, 2, 1, 1, ","89":"89\\n5, 7, 2, 1, 1, ","190":"190\\n4, 6, 2, 1, 2, ","191":"191\\n2, 4, 5, 1, 1, ","192":"192\\n2, 4, 5, 1, 1, ","193":"193\\n2, 4, 5, 1, 1, ","194":"194\\n3, 5, 3, 1, 2, ","195":"195\\n3, 5, 3, 1, 2, ","196":"196\\n3, 5, 3, 1, 2, ","197":"197\\n3, 5, 3, 1, 2, ","198":"198\\n3, 5, 3, 1, 2, ","199":"199\\n3, 5, 3, 1, 2, ","90":"90\\n4, 6, 4, 1, 0, ","91":"91\\n5, 7, 2, 1, 1, ","92":"92\\n5, 7, 2, 1, 1, ","93":"93\\n5, 7, 2, 1, 1, ","94":"94\\n5, 7, 2, 1, 1, ","95":"95\\n5, 7, 2, 1, 1, ","96":"96\\n6, 8, 0, 1, 2, ","97":"97\\n5, 7, 2, 1, 1, ","98":"98\\n5, 7, 2, 1, 1, ","99":"99\\n6, 8, 0, 1, 2, ","200":"200\\n3, 5, 3, 1, 2, ","201":"201\\n3, 5, 3, 1, 2, ","202":"202\\n4, 6, 1, 1, 3, ","203":"203\\n3, 5, 3, 1, 2, ","204":"204\\n3, 5, 3, 1, 2, ","205":"205\\n3, 5, 3, 1, 2, ","206":"206\\n3, 5, 3, 1, 2, ","207":"207\\n4, 6, 1, 1, 3, ","208":"208\\n4, 6, 1, 1, 3, ","209":"209\\n2, 4, 4, 1, 2, ","210":"210\\n2, 4, 4, 1, 2, ","211":"211\\n2, 4, 4, 1, 2, ","212":"212\\n3, 5, 2, 1, 3, ","213":"213\\n3, 5, 2, 1, 3, ","214":"214\\n3, 5, 2, 1, 3, ","215":"215\\n2, 4, 3, 1, 3, ","100":"100\\n4, 6, 4, 1, 0, ","101":"101\\n5, 7, 2, 1, 1, ","102":"102\\n5, 7, 2, 1, 1, ","103":"103\\n5, 7, 2, 1, 1, ","104":"104\\n5, 7, 2, 1, 1, ","105":"105\\n5, 7, 2, 1, 1, ","106":"106\\n5, 7, 2, 1, 1, ","107":"107\\n6, 8, 0, 1, 2, ","108":"108\\n3, 5, 5, 1, 0, ","109":"109\\n3, 5, 5, 1, 0, "},"arc":{"110":[162,157,159],"111":[160,162,158],"112":[163,164,156],"113":[163,157],"114":[163,165,159],"115":[161,164,165],"116":[166,167,168,156],"117":[166,169,157],"118":[167,169,158],"119":[166,170,171,159],"10":[33,36,27,31],"11":[32,34,36,37,28],"12":[38,39,40,25,41],"13":[38,26,42,43,44,45],"14":[39,42,27,46,47],"15":[48,49,40,43,28,46],"16":[48,41,44,29,47],"17":[50,51,52,38,30],"18":[50,53,39,31],"19":[32,51,53,54,40],"120":[160,167,170,172],"0":[1,2,3,4,5,6],"121":[161,168,171,172],"1":[7,8,9,10,11],"122":[162,169,170],"2":[16,7,12,13,14,15],"123":[163,166,173],"3":[17,18,19,8,12],"124":[164,168,173],"4":[17,20,21,22,9,13],"125":[165,171,173],"5":[18,20,23,10,14],"126":[156,174,175],"6":[19,21,23,24,11,15],"127":[158,174],"7":[25,26,27,28,29],"128":[160,176,174],"8":[32,25,30,31],"129":[176,161,175],"9":[33,34,35,26,30],"20":[33,50,55,56,42],"21":[34,51,55,57,58,43],"22":[35,52,56,57,45],"23":[36,53,55,59,46],"24":[49,37,54,58,59],"25":[60,61,62,63],"26":[64,65,66,67,60],"27":[64,68,69,61],"28":[65,68,70,71,62],"29":[66,69,70,63],"130":[164,175],"131":[177,167,174],"132":[177,168,175],"133":[176,177,172],"134":[178,179,180,156],"135":[178,181,157],"136":[179,181,158],"137":[178,182,183,159],"138":[160,179,182,184],"139":[161,180,183,184],"30":[72,73,74,60],"31":[72,75,61],"32":[73,75,76,62],"33":[64,72,77,78],"34":[80,65,73,77,79],"35":[67,74,78,79],"36":[81,68,75,77],"37":[80,81,71,76],"38":[82,83,84,85,60],"39":[82,86,87,61],"140":[162,181,182],"141":[178,163,185],"142":[164,180,185],"143":[165,183,185],"144":[178,166,186,187],"145":[179,167,186,188],"146":[180,168,187,188],"147":[181,169,186],"148":[182,170,186,189],"149":[183,171,187,189],"40":[83,86,88,89,62],"41":[84,87,88,63],"42":[64,82,90,91,92],"43":[65,83,90,93,94,95],"44":[96,66,84,91,93],"45":[96,67,85,92,94],"46":[97,98,68,86,90],"47":[97,69,87,91],"48":[97,99,70,88,93],"49":[98,99,71,89,95],"150":[184,172,188,189],"151":[185,187,173],"152":[179,174,190],"153":[180,190,175],"154":[176,184,190],"155":[177,188,190],"156":[192,193,191],"157":[194,191],"158":[192,194],"159":[195,196,191],"50":[82,100,101,72],"51":[83,100,102,103,73],"52":[85,101,102,74],"53":[100,86,104,75],"54":[103,104,89,76],"55":[100,105,90,106,77],"56":[101,105,92,78],"57":[102,105,107,94,79],"58":[80,103,106,107,95],"59":[81,98,104,106],"160":[192,195,197],"161":[193,196,197],"162":[194,195],"163":[198,191],"164":[193,198],"165":[196,198],"166":[199,200,191],"167":[192,199,201],"168":[193,200,201],"169":[194,199],"60":[108,109,110,111],"61":[112,113,108],"62":[112,114,115,109],"63":[113,114,110],"64":[116,117,118,108],"65":[116,119,120,121,109],"66":[117,119,122,110],"67":[118,120,122,111],"68":[112,116,123,124],"69":[113,117,123],"170":[195,199,202],"171":[196,200,202],"172":[197,201,202],"173":[198,200],"174":[192,203],"175":[193,203],"176":[197,203],"177":[201,203],"178":[204,205,191],"179":[192,204,206],"70":[114,119,123,125],"71":[115,121,124,125],"72":[108,126,127],"73":[128,129,109,126],"74":[128,111,127],"75":[112,130,126],"76":[129,130,115],"77":[131,116,132,126],"78":[131,118,127],"79":[128,131,133,120],"180":[193,205,206],"181":[194,204],"182":[195,204,207],"183":[196,205,207],"184":[197,206,207],"185":[198,205],"186":[208,199,204],"187":[208,200,205],"188":[208,201,206],"189":[208,202,207],"80":[129,132,133,121],"81":[130,132,124],"82":[134,135,136,108],"83":[134,137,138,139,109],"84":[135,137,140,110],"85":[136,138,140,111],"86":[112,134,141,142],"87":[113,135,141],"88":[114,137,141,143],"89":[115,139,142,143],"190":[203,206],"191":[209,210],"192":[209,211],"193":[210,211],"194":[209],"195":[209,212],"196":[210,212],"197":[211,212],"198":[210],"199":[209,213],"90":[144,145,146,116,134],"91":[144,147,117,135],"92":[145,147,118,136],"93":[144,148,149,119,137],"94":[145,148,150,120,138],"95":[146,149,150,121,139],"96":[147,148,122,140],"97":[144,151,123,141],"98":[146,151,124,142],"99":[149,151,125,143],"200":[210,213],"201":[211,213],"202":[212,213],"203":[211],"204":[209,214],"205":[210,214],"206":[211,214],"207":[212,214],"208":[213,214],"209":[215],"210":[215],"211":[215],"212":[215],"213":[215],"214":[215],"100":[134,152,153,126],"101":[136,152,127],"102":[128,152,138,154],"103":[129,153,154,139],"104":[130,153,142],"105":[145,131,152,155],"106":[146,132,153,155],"107":[133,150,154,155],"108":[156,157,158],"109":[160,161,156,159]}}
`
)

app.use(bodyParser.json());
app.use(bodyParser.urlencoded({
  extended: true
}));

app.listen(port, () => {
  console.log(`Interface listening on port ${port}!`)
})

app.get('/', (req,res) =>{
  res.sendFile(__dirname + '/app.html')
})

io.on('connect', socket =>{
  let graph = dotParser.graph(ss)
  viz.renderString(graph,{engine: 'dot'})
  .then(result => {
    socket.emit('graph',result)
  })
  .catch(error => {
    console.error(error)
  });
  socket.emit('graph',result)
})
