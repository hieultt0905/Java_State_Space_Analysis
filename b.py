
import inspect
import json
import pyspark
from pyspark import SparkContext
from pyspark.sql import SQLContext
from graphframes import GraphFrame

sc = SparkContext("local", "graph")
sqlContext = SQLContext(sc)

raw = json.loads("""
{"node":{"22":{"0":"[['c']]","1":"[[3]]","2":"[['b', 1], ['a', 2]]"},"23":{"0":"[['c']]","1":"[[2]]","2":"[['a', 3], ['b', 1]]"},"24":{"0":"[['c']]","1":"[[3]]","2":"[['b', 2], ['a', 1]]"},"25":{"0":"[['c']]","1":"[[1]]","2":"[['b', 2], ['a', 3]]"},"26":{"0":"[['c']]","1":"[[2]]","2":"[['a', 1], ['b', 3]]"},"27":{"0":"[['c']]","1":"[[1]]","2":"[['a', 2], ['b', 3]]"},"28":{"0":"[]","1":"[]","2":"[['c', 1], ['b', 2], ['a', 3]]"},"29":{"0":"[]","1":"[]","2":"[['c', 1], ['a', 2], ['b', 3]]"},"30":{"0":"[]","1":"[]","2":"[['a', 3], ['b', 1], ['c', 2]]"},"31":{"0":"[]","1":"[]","2":"[['a', 1], ['c', 2], ['b', 3]]"},"10":{"0":"[['a']]","1":"[[3]]","2":"[['c', 1], ['b', 2]]"},"32":{"0":"[]","1":"[]","2":"[['b', 1], ['a', 2], ['c', 3]]"},"11":{"0":"[['a']]","1":"[[2]]","2":"[['c', 1], ['b', 3]]"},"33":{"0":"[]","1":"[]","2":"[['b', 2], ['a', 1], ['c', 3]]"},"12":{"0":"[['b']]","1":"[[3]]","2":"[['c', 1], ['a', 2]]"},"13":{"0":"[['b']]","1":"[[2]]","2":"[['c', 1], ['a', 3]]"},"14":{"0":"[['a']]","1":"[[3]]","2":"[['b', 1], ['c', 2]]"},"15":{"0":"[['a']]","1":"[[1]]","2":"[['c', 2], ['b', 3]]"},"16":{"0":"[['b']]","1":"[[3]]","2":"[['a', 1], ['c', 2]]"},"17":{"0":"[['b']]","1":"[[1]]","2":"[['a', 3], ['c', 2]]"},"18":{"0":"[['a']]","1":"[[2]]","2":"[['b', 1], ['c', 3]]"},"19":{"0":"[['a']]","1":"[[1]]","2":"[['b', 2], ['c', 3]]"},"0":{"0":"[['c'], ['b'], ['a']]","1":"[[1], [2], [3]]","2":"[]"},"1":{"0":"[['b'], ['a']]","1":"[[2], [3]]","2":"[['c', 1]]"},"2":{"0":"[['b'], ['a']]","1":"[[1], [3]]","2":"[['c', 2]]"},"3":{"0":"[['b'], ['a']]","1":"[[1], [2]]","2":"[['c', 3]]"},"4":{"0":"[['c'], ['a']]","1":"[[2], [3]]","2":"[['b', 1]]"},"5":{"0":"[['c'], ['a']]","1":"[[1], [3]]","2":"[['b', 2]]"},"6":{"0":"[['c'], ['a']]","1":"[[1], [2]]","2":"[['b', 3]]"},"7":{"0":"[['c'], ['b']]","1":"[[2], [3]]","2":"[['a', 1]]"},"8":{"0":"[['c'], ['b']]","1":"[[1], [3]]","2":"[['a', 2]]"},"9":{"0":"[['c'], ['b']]","1":"[[1], [2]]","2":"[['a', 3]]"},"20":{"0":"[['b']]","1":"[[2]]","2":"[['a', 1], ['c', 3]]"},"21":{"0":"[['b']]","1":"[[1]]","2":"[['a', 2], ['c', 3]]"}},"arc":{"[4, 14]":0,"[7, 20]":0,"[5, 19]":0,"[7, 16]":0,"[4, 18]":0,"[7, 24]":0,"[2, 17]":0,"[3, 21]":0,"[8, 21]":0,"[0, 6]":0,"[6, 27]":0,"[6, 15]":0,"[11, 29]":0,"[9, 17]":0,"[0, 2]":0,"[6, 11]":0,"[1, 12]":0,"[4, 22]":0,"[9, 25]":0,"[9, 13]":0,"[4, 23]":0,"[2, 16]":0,"[8, 12]":0,"[25, 28]":0,"[0, 7]":0,"[5, 24]":0,"[12, 29]":0,"[0, 3]":0,"[6, 26]":0,"[3, 18]":0,"[16, 31]":0,"[20, 33]":0,"[1, 11]":0,"[22, 32]":0,"[7, 26]":0,"[8, 27]":0,"[2, 15]":0,"[21, 32]":0,"[0, 8]":0,"[5, 25]":0,"[18, 32]":0,"[3, 19]":0,"[0, 4]":0,"[23, 30]":0,"[13, 28]":0,"[1, 10]":0,"[9, 23]":0,"[15, 31]":0,"[10, 28]":0,"[3, 20]":0,"[2, 14]":0,"[0, 9]":0,"[8, 22]":0,"[26, 31]":0,"[0, 5]":0,"[5, 10]":0,"[0, 1]":0,"[24, 33]":0,"[17, 30]":0,"[27, 29]":0,"[14, 30]":0,"[19, 33]":0,"[1, 13]":0}}
""")
#build a graph from json input
temp = []
for id in raw['node']:
    marking = {}
    for m in raw['node'][id]:
        marking[m] = raw['node'][id][m]
    temp.append((int(id),marking))

v = sqlContext.createDataFrame(temp, ['id','marking'])

temp = []
for i in raw['arc']:
    src,dst = eval(i)
    temp.append((src,dst,raw['arc'][i]))

e = sqlContext.createDataFrame(temp, ['src','dst','transition'])

graph = GraphFrame(v,e)

#basic query
graph.vertices\
.filter('id>20 and id<30')\
.filter('id%2 == 1')\
.select('id')\
.show(1000)
